"use strict";(self.webpackChunkgcds_map=self.webpackChunkgcds_map||[]).push([[153],{"./dist/esm/MapTileLayer-dNMHgVBV.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{M:()=>MapTileLayer,m:()=>mapTileLayer});var _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./dist/esm/index-PZrWUcjo.js"),MapTileLayer=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.GridLayer.extend({initialize:function(options){_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.GridLayer.prototype.initialize.call(this,options),this._mapTiles=options.mapTiles||[],this._tileMap={},this._pendingTiles={},this._buildTileMap(),this._container=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.create("div","leaflet-layer"),options.zIndex&&(this._container.style.zIndex=options.zIndex),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.addClass(this._container,"mapml-static-tile-container")},getEvents:function(){const events=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.GridLayer.prototype.getEvents?_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.GridLayer.prototype.getEvents.call(this):{};return events.zoomend=this._handleZoomChange,events},onAdd:function(map){this.options.pane.appendChild(this._container),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.GridLayer.prototype.onAdd.call(this,map)},onRemove:function(map){this._pendingTiles={},_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.remove(this._container)},setZIndex:function(zIndex){return this.options.zIndex=zIndex,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_handleZoomChange:function(){const currentZoom=this._map.getZoom();for(const key in this._tiles){this._keyToTileCoords(key).z!==currentZoom&&this._removeTile(key)}},addMapTile:function(mapTile){this._mapTiles.includes(mapTile)||(this._mapTiles.push(mapTile),this._addToTileMap(mapTile),this._updateBounds(),this._map&&this.redraw())},removeMapTile:function(mapTile){const index=this._mapTiles.indexOf(mapTile);-1!==index&&(this._mapTiles.splice(index,1),this._removeFromTileMap(mapTile),this._updateBounds(),this._map&&this.redraw())},removeMapTileAt:function(mapTile,coords){const index=this._mapTiles.indexOf(mapTile);-1!==index&&(this._mapTiles.splice(index,1),this._removeFromTileMapAt(coords),mapTile._tileDiv&&(mapTile._tileDiv._mapTile=null,mapTile._tileDiv=null),this._updateBounds(),this._map&&this.redraw())},isVisible:function(){if(!this._map)return!1;this.layerBounds||this._updateBounds();let map=this._map,mapZoom=map.getZoom(),zoomBounds=this.zoomBounds,layerBounds=this.layerBounds;return mapZoom<=zoomBounds.maxZoom&&mapZoom>=zoomBounds.minZoom&&this._mapTiles&&layerBounds&&layerBounds.overlaps(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.pixelToPCRSBounds(map.getPixelBounds(),mapZoom,map.options.projection))},createTile:function(coords,done){const tileKey=this._tileCoordsToKey(coords),tileSize=this.getTileSize(),tileElement=document.createElement("div");tileElement.setAttribute("col",coords.x),tileElement.setAttribute("row",coords.y),tileElement.setAttribute("zoom",coords.z),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.addClass(tileElement,"leaflet-tile"),tileElement.style.width=tileSize.x+"px",tileElement.style.height=tileSize.y+"px";const matchingTile=this._tileMap[tileKey];if(matchingTile){const img=document.createElement("img");img.src=matchingTile.src,img.width=tileSize.x,img.height=tileSize.y,img.alt="",img.setAttribute("role","presentation"),tileElement._mapTile=matchingTile,matchingTile._tileDiv=tileElement,tileElement.appendChild(img),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.addClass(tileElement,"leaflet-tile-loaded"),done(null,tileElement)}else this._pendingTiles||(this._pendingTiles={}),this._pendingTiles[tileKey]={element:tileElement,done};return tileElement},_buildTileMap:function(){this._tileMap={};for(const mapTile of this._mapTiles)this._addToTileMap(mapTile)},_addToTileMap:function(mapTile){const tileKey=`${mapTile.col}:${mapTile.row}:${mapTile.zoom}`;if(this._tileMap[tileKey]=mapTile,this._pendingTiles&&this._pendingTiles[tileKey]){const pendingTile=this._pendingTiles[tileKey],tileElement=pendingTile.element,doneCallback=pendingTile.done,tileSize=this.getTileSize(),img=document.createElement("img");img.src=mapTile.src,img.width=tileSize.x,img.height=tileSize.y,img.alt="",img.setAttribute("role","presentation"),tileElement._mapTile=mapTile,mapTile._tileDiv=tileElement,tileElement.appendChild(img),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.DomUtil.addClass(tileElement,"leaflet-tile-loaded"),doneCallback&&doneCallback(null,tileElement),delete this._pendingTiles[tileKey]}},_removeFromTileMap:function(mapTile){const tileKey=`${mapTile.col}:${mapTile.row}:${mapTile.zoom}`;delete this._tileMap[tileKey],mapTile._tileDiv&&(mapTile._tileDiv._mapTile=null,mapTile._tileDiv=null),this._pendingTiles&&this._pendingTiles[tileKey]&&delete this._pendingTiles[tileKey]},_removeFromTileMapAt:function(coords){const tileKey=`${coords.col}:${coords.row}:${coords.zoom}`;delete this._tileMap[tileKey],this._pendingTiles&&this._pendingTiles[tileKey]&&delete this._pendingTiles[tileKey]},_updateBounds:function(){this.layerBounds=this._computeLayerBounds(),this.zoomBounds=this._computeZoomBounds()},_computeLayerBounds:function(){if(0===this._mapTiles.length)return _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds([0,0],[0,0]);const tilesByZoom={},projection=this.options.projection,tileSize=M[projection].options.crs.tile.bounds.max.x;for(const mapTile of this._mapTiles){const zoom=mapTile.zoom;tilesByZoom[zoom]||(tilesByZoom[zoom]=[]),tilesByZoom[zoom].push({x:mapTile.col,y:mapTile.row,z:zoom})}const layerBoundsByZoom={};for(const zoom in tilesByZoom){const tiles=tilesByZoom[zoom];let pixelBounds=null;for(const tile of tiles){const pixelX=tile.x*tileSize,pixelY=tile.y*tileSize;pixelBounds?(pixelBounds.extend(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(pixelX,pixelY)),pixelBounds.extend(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(pixelX+tileSize,pixelY+tileSize))):pixelBounds=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(pixelX,pixelY),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(pixelX+tileSize,pixelY+tileSize))}pixelBounds&&(layerBoundsByZoom[zoom]=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.pixelToPCRSBounds(pixelBounds,parseInt(zoom),projection))}let combinedBounds=null;for(const zoom in layerBoundsByZoom)combinedBounds?(combinedBounds.extend(layerBoundsByZoom[zoom].min),combinedBounds.extend(layerBoundsByZoom[zoom].max)):combinedBounds=layerBoundsByZoom[zoom].pad(0);return combinedBounds||_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds([0,0],[0,0])},_computeZoomBounds:function(){const result={minZoom:1/0,maxZoom:-1/0,minNativeZoom:1/0,maxNativeZoom:-1/0};if(0===this._mapTiles.length)return{minZoom:0,maxZoom:22,minNativeZoom:0,maxNativeZoom:22};for(const mapTile of this._mapTiles){const zoom=mapTile.zoom;result.minNativeZoom=Math.min(result.minNativeZoom,zoom),result.maxNativeZoom=Math.max(result.maxNativeZoom,zoom)}return result.minZoom=result.minNativeZoom,result.maxZoom=result.maxNativeZoom,result}}),mapTileLayer=function(options){return new MapTileLayer(options)}},"./dist/esm/calculatePosition-B4YLD_Og.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function calculatePosition(element){const tagName=element.tagName.toLowerCase(),validTags=["map-tile","map-extent","map-feature"];if(!validTags.includes(tagName))return console.warn(`calculatePosition: Invalid element type ${tagName}`),0;const parent=element.parentNode;if(!parent)return 1;const children=parent.children||Array.from(parent.childNodes).filter(node=>node.nodeType===Node.ELEMENT_NODE);if(!children||0===children.length)return 1;let position=0,lastTag=null,foundTarget=!1;for(const child of children){if(child.nodeType!==Node.ELEMENT_NODE)continue;const childTag=child.tagName.toLowerCase();if(validTags.includes(childTag)){if(child===element)return foundTarget=!0,"map-extent"===childTag?(position++,position):(lastTag===childTag||position++,position);foundTarget||("map-extent"===childTag||null!==lastTag&&lastTag!==childTag?position++:null===lastTag&&(position=1),lastTag=childTag)}}return 0}__webpack_require__.d(__webpack_exports__,{c:()=>calculatePosition})},"./dist/esm/map-tile.entry.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{map_tile:()=>MapTile});var _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./dist/esm/index-PZrWUcjo.js"),_MapTileLayer_dNMHgVBV_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./dist/esm/MapTileLayer-dNMHgVBV.js"),_calculatePosition_B4YLD_Og_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./dist/esm/calculatePosition-B4YLD_Og.js");const MapTile=class{constructor(hostRef){(0,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.r)(this,hostRef)}get el(){return(0,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.a)(this)}row;col;zoom;src;_parentEl;_tileLayer;_extent;_initialRow;_initialCol;_initialZoom;_hasConnected=!1;srcChanged(newValue,oldValue){oldValue!==newValue&&(this._extent&&this._calculateExtent(),this._tileLayer&&(this._tileLayer.removeMapTile(this.el),this._tileLayer.addMapTile(this.el)))}connectedCallback(){this._initialRow=this.el.hasAttribute("row")?+this.el.getAttribute("row"):this.row??0,this._initialCol=this.el.hasAttribute("col")?+this.el.getAttribute("col"):this.col??0;let zoomValue=0;if(this.el.hasAttribute("zoom"))zoomValue=+this.el.getAttribute("zoom");else if(void 0!==this.zoom)zoomValue=this.zoom;else{const metaZoom=this._getMetaZoomValue();zoomValue=null!==metaZoom?metaZoom:this.getMapEl()?.zoom||0}this._initialZoom=zoomValue,this._hasConnected=!0;const originalGetAttribute=this.el.getAttribute.bind(this.el),originalSetAttribute=this.el.setAttribute.bind(this.el);this.el.getAttribute=name=>{if(this._hasConnected)switch(name){case"row":return String(this._initialRow);case"col":return String(this._initialCol);case"zoom":return String(this._initialZoom)}return originalGetAttribute(name)},this.el.setAttribute=(name,value)=>{if(this._hasConnected)switch(name){case"row":case"col":case"zoom":return}originalSetAttribute(name,value)},Object.defineProperties(this.el,{row:{get:()=>this._initialRow,configurable:!0},col:{get:()=>this._initialCol,configurable:!0},zoom:{get:()=>this._initialZoom,configurable:!0}});const parentNode=this.el.parentNode;this._parentEl="MAP-LAYER"===parentNode.nodeName||"LAYER-"===parentNode.nodeName||"MAP-LINK"===parentNode.nodeName?parentNode:parentNode.host;(new Image).src=this.src||"",this._createOrGetTileLayer()}disconnectedCallback(){if(this._tileLayer&&(this._tileLayer.removeMapTile(this.el),this._tileLayer._mapTiles&&0===this._tileLayer._mapTiles.length)){this._tileLayer.remove(),this._tileLayer=null,delete this._tileLayer;const entry=this?._parentEl?._layerRegistry?.get(this.position);entry&&(entry.count--,0===entry.count&&this._parentEl._layerRegistry.delete(this.position))}}get rowValue(){return this._hasConnected?this._initialRow:+this.row}get colValue(){return this._hasConnected?this._initialCol:+this.col}get zoomValue(){return this._hasConnected?this._initialZoom:+this.zoom}get extent(){return this._extent||this._calculateExtent(),this._extent}get position(){return(0,_calculatePosition_B4YLD_Og_js__WEBPACK_IMPORTED_MODULE_2__.c)(this.el)}isFirst(){return!this._parentEl._layerRegistry.has(this.position)}getPrevious(){return this.isFirst()?null:this.el.previousElementSibling}async zoomTo(){const extent=this.extent,map=this.getMapEl()?._map;if(!extent||!map)return;const xmin=extent.topLeft.pcrs.horizontal,xmax=extent.bottomRight.pcrs.horizontal,ymin=extent.bottomRight.pcrs.vertical,ymax=extent.topLeft.pcrs.vertical,bounds=window.L.bounds(window.L.point(xmin,ymin),window.L.point(xmax,ymax)),center=map.options.crs.unproject(bounds.getCenter(!0)),maxZoom=extent.zoom.maxZoom,minZoom=extent.zoom.minZoom;map.setView(center,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getMaxZoom(bounds,map,minZoom,maxZoom),{animate:!1})}getMapEl(){return _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getClosest(this.el,"gcds-map")}getLayerEl(){return _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getClosest(this.el,"map-layer,layer-")}_getMetaZoomValue(){const layerEl=this.getLayerEl();if(!layerEl)return null;const metaZoom=layerEl.querySelector('map-meta[name="zoom"][content]');if(!metaZoom)return null;const content=metaZoom.getAttribute("content");if(!content)return null;const valueMatch=content.match(/value=(\d+)/);return valueMatch&&valueMatch[1]?parseInt(valueMatch[1],10):null}getMeta(metaName){const name=metaName.toLowerCase();if("cs"!==name&&"zoom"!==name&&"projection"!==name)return;const sdMeta=this._parentEl?.shadowRoot?.querySelector(`map-meta[name=${name}][content]`);return"MAP-LINK"===this._parentEl?.nodeName?sdMeta||this._parentEl.parentElement?.getMeta(metaName):this._parentEl?.src?this._parentEl.shadowRoot?.querySelector(`map-meta[name=${name}][content]`):this._parentEl.querySelector(`map-meta[name=${name}][content]`)}async _createOrGetTileLayer(){if(!this._parentEl?.whenReady)return;await this._parentEl.whenReady();const parentElement=this._parentEl;if(this.isFirst())this._tileLayer=(0,_MapTileLayer_dNMHgVBV_js__WEBPACK_IMPORTED_MODULE_1__.m)({projection:this.getMapEl()?.projection,opacity:1,pane:parentElement._templatedLayer?.getContainer?.()||parentElement._layer?.getContainer?.(),zIndex:this.position}),this._tileLayer.addMapTile(this.el),parentElement._templatedLayer?.addLayer?parentElement._templatedLayer.addLayer(this._tileLayer):parentElement._layer?.addLayer?.(this._tileLayer),this.el._tileLayer=this._tileLayer,parentElement._layerRegistry.set(this.position,{layer:this._tileLayer,count:1});else{const entry=parentElement._layerRegistry.get(this.position);this._tileLayer=entry?.layer,entry&&entry.count++,this._tileLayer&&(this._tileLayer.addMapTile(this.el),this.el._tileLayer=this._tileLayer)}}_calculateExtent(){const mapEl=this.getMapEl();if(!mapEl||!mapEl._map)return;const map=mapEl._map,projection=map.options.projection,tileSize=window.M[projection].options.crs.tile.bounds.max.x,pixelX=this.colValue*tileSize,pixelY=this.rowValue*tileSize,pixelBounds=window.L.bounds(window.L.point(pixelX,pixelY),window.L.point(pixelX+tileSize,pixelY+tileSize)),pcrsBounds=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.pixelToPCRSBounds(pixelBounds,this.zoomValue,projection);this._extent=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._convertAndFormatPCRS(pcrsBounds,map.options.crs,projection),this._extent.zoom={minZoom:this.zoomValue,maxZoom:this.zoomValue,minNativeZoom:this.zoomValue,maxNativeZoom:this.zoomValue}}render(){return null}static get watchers(){return{src:["srcChanged"]}}}}}]);