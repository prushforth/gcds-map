import{l as t,r as e,a as i,U as s}from"./p-PZrWUcjo.js";import{r as a}from"./p-EYVT9Efh.js";import{c as n}from"./p-B4YLD_Og.js";var h=t.LayerGroup.extend({initialize:function(e){t.LayerGroup.prototype.initialize.call(this,null,e);this._container=t.DomUtil.create("div","leaflet-layer");this._extentEl=this.options.extentEl;this.changeOpacity(this.options.opacity);this.setZIndex(e.zIndex);t.DomUtil.addClass(this._container,"mapml-extentlayer-container")},getEvents:function(){return{zoomstart:this._onZoomStart}},_onZoomStart:function(){this.closePopup()},getContainer:function(){return this._container},onAdd:function(e){t.LayerGroup.prototype.onAdd.call(this,e);let i=this.options.extentEl.parentLayer._layer._container;i.appendChild(this._container)},redraw:function(){this.eachLayer((function(t){t.redraw()}))},setZIndex:function(t){this.options.zIndex=t;this._updateZIndex();return this},_updateZIndex:function(){if(this._container&&this.options.zIndex!==undefined&&this.options.zIndex!==null){this._container.style.zIndex=this.options.zIndex}},onRemove:function(){t.LayerGroup.prototype.onRemove.call(this,this._map);t.DomUtil.remove(this._container)},_previousFeature:function(t){if(this._count+-1>=0){this._count--;this._map.fire("featurepagination",{i:this._count,popup:this})}},_nextFeature:function(t){if(this._count+1<this._source._totalFeatureCount){this._count++;this._map.fire("featurepagination",{i:this._count,popup:this})}},changeOpacity:function(t){this._container.style.opacity=t;this._extentEl._opacity=t;if(this._extentEl._opacitySlider)this._extentEl._opacitySlider.value=t},renderStyles:a});var r=function(t){return new h(t)};var l=function(){var e=t.DomUtil.create("fieldset","mapml-layer-extent"),i=t.DomUtil.create("div","mapml-layer-item-properties",e),s=t.DomUtil.create("div","mapml-layer-item-settings",e),a=t.DomUtil.create("label","mapml-layer-item-toggle",i),n=t.DomUtil.create("input"),h=t.SVG.create("svg"),r=t.SVG.create("path"),l=t.SVG.create("path"),o=t.DomUtil.create("span"),m=t.DomUtil.create("div","mapml-layer-item-controls",i),c=t.DomUtil.create("details","mapml-layer-item-details mapml-control-layers",s),f=t.DomUtil.create("summary","",c),u=this.getMapEl(),d=this.getLayerEl(),p=t.DomUtil.create("input","",c);s.hidden=true;e.setAttribute("aria-grabbed","false");h.setAttribute("viewBox","0 0 24 24");h.setAttribute("height","22");h.setAttribute("width","22");r.setAttribute("d","M0 0h24v24H0z");r.setAttribute("fill","none");l.setAttribute("d","M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z");h.appendChild(r);h.appendChild(l);let b=this.el.querySelectorAll("map-select");if(b.length){var g=document.createDocumentFragment();for(var y=0;y<b.length;y++){g.appendChild(b[y].selectdetails)}s.appendChild(g)}let v=t.DomUtil.create("button","mapml-layer-item-remove-control",m);v.type="button";v.title=u.locale.lmRemoveExtent;v.innerHTML="<span aria-hidden='true'>&#10005;</span>";v.classList.add("mapml-button");v.addEventListener("click",(t=>{t.preventDefault();t.stopPropagation();this.el.remove()}));let x=t.DomUtil.create("button","mapml-layer-item-settings-control",m);x.type="button";x.title=u.locale.lmExtentSettings;x.setAttribute("aria-expanded",false);x.classList.add("mapml-button");t.DomEvent.on(x,"click",(t=>{if(s.hidden===true){x.setAttribute("aria-expanded",true);s.hidden=false}else{x.setAttribute("aria-expanded",false);s.hidden=true}}),this);o.setAttribute("aria-hidden",true);a.appendChild(n);x.appendChild(o);o.appendChild(h);f.innerText=u.locale.lcOpacity;f.id="mapml-extent-item-opacity-"+t.stamp(f);p.setAttribute("type","range");p.setAttribute("min","0");p.setAttribute("max","1.0");p.setAttribute("step","0.1");p.setAttribute("aria-labelledby","mapml-extent-item-opacity-"+t.stamp(f));const k=function(t){if(t&&t.target&&t.target.value>=0&&t.target.value<=1){this._extentLayer.changeOpacity(t.target.value)}};p.setAttribute("value",this.opacity);p.value=this._extentLayer._container.style.opacity||"1.0";p.addEventListener("change",k.bind(this));var _=t.DomUtil.create("span","mapml-extent-item-name",a);n.type="checkbox";n.defaultChecked=this.checked;_.innerHTML=this.label;const w=function(){this.checked=!this.checked;this.el.dispatchEvent(new CustomEvent("map-change"))};this._layerControlCheckbox=n;n.addEventListener("change",w.bind(this));_.id="mapml-extent-item-name-{"+t.stamp(_)+"}";e.setAttribute("aria-labelledby",_.id);_.extent=this.el;e.ontouchstart=e.onmousedown=t=>{if(t.target.parentElement.tagName.toLowerCase()==="label"&&t.target.tagName.toLowerCase()!=="input"||t.target.tagName.toLowerCase()==="label"){t.stopPropagation();t=t instanceof TouchEvent?t.touches[0]:t;let i=e,s=e.parentNode,a=false,n=t.clientY,h=Array.from(e.parentElement.querySelectorAll("fieldset")).indexOf(e);document.body.ontouchmove=document.body.onmousemove=t=>{t.preventDefault();t=t instanceof TouchEvent?t.touches[0]:t;let e=t.clientY-n;a=Math.abs(e)>15||a;if(s&&!a||s&&s.childElementCount<=1||s.getBoundingClientRect().top>i.getBoundingClientRect().bottom||s.getBoundingClientRect().bottom<i.getBoundingClientRect().top){return}s.classList.add("mapml-draggable");i.style.transform="translateY("+e+"px)";i.style.pointerEvents="none";let h=t.clientX,r=t.clientY,l=u.tagName==="GCDS-MAP"?u.shadowRoot:u.querySelector(".mapml-web-map").shadowRoot,o=l.elementFromPoint(h,r),m=!o||!o.closest("fieldset")?i:o.closest("fieldset");m=Math.abs(e)<=m.offsetHeight?i:m;i.setAttribute("aria-grabbed","true");i.setAttribute("aria-dropeffect","move");if(m&&s===m.parentNode){m=m!==i.nextSibling?m:m.nextSibling;if(i!==m){n=t.clientY;i.style.transform=null}s.insertBefore(i,m)}};document.body.ontouchend=document.body.onmouseup=()=>{let t=Array.from(e.parentElement.querySelectorAll("fieldset")).indexOf(e);i.setAttribute("aria-grabbed","false");i.removeAttribute("aria-dropeffect");i.style.pointerEvents=null;i.style.transform=null;if(h!==t){let t=s.children,e=0;for(let i of t){let t=i.querySelector("span").extent;t.setAttribute("data-moving","");const s=d.src?d.shadowRoot:d;s.append(t);t.removeAttribute("data-moving");t.extentZIndex=e;t._extentLayer.setZIndex(e);e++}}s.classList.remove("mapml-draggable");document.body.ontouchmove=document.body.onmousemove=document.body.ontouchend=document.body.onmouseup=null}}};this._extentRootFieldset=e;this._opacitySlider=p;this._opacityControl=c;this._layerControlLabel=a;return e};const o=class{constructor(t){e(this,t)}get el(){return i(this)}checked=false;_label;opacity=1;_opacity;hidden=false;units;disabled=false;get label(){return this._label||this.mapEl?.locale?.dfExtent||"Sub-layer"}get opacityValue(){return this._opacity??this.opacity??1}mapEl;parentLayer;_map;_extentLayer;_layerControlHTML;_layerControlCheckbox;_layerControlLabel;_opacityControl;_opacitySlider;_selectdetails;_observer;_changeHandler;_boundsCalculated=false;unitsChanged(t,e){}labelChanged(){if(this._layerControlHTML){this._layerControlHTML.querySelector(".mapml-extent-item-name").textContent=this.label}}checkedChanged(){if(this.parentLayer&&this._extentLayer){this.parentLayer.whenReady().then((()=>{this._handleChange();this._calculateBounds();if(this._layerControlCheckbox){this._layerControlCheckbox.checked=this.checked}})).catch((t=>{console.log("Error while waiting on parentLayer for map-extent checked callback: "+t)}))}}opacityChanged(t,e){if(e!==t&&this._extentLayer){this._opacity=t;this._extentLayer.changeOpacity(t);if(this._opacitySlider){this._opacitySlider.value=t.toString()}}}hiddenChanged(t,e){if(e!==t&&this._extentLayer&&this._layerControlHTML){this._applyHiddenState(t)}}_applyHiddenState(t){if(!this._extentLayer||!this._layerControlHTML||!this.parentLayer)return;this.parentLayer.whenReady().then((()=>{let e=this.parentLayer._propertiesGroupAnatomy;const i=this.parentLayer.src?Array.from(this.parentLayer.shadowRoot.querySelectorAll(":host > map-extent")):Array.from(this.parentLayer.querySelectorAll(":scope > map-extent"));const s=i.filter((t=>!t.hidden));let a=s.indexOf(this.el);if(t){this._layerControlHTML.remove()}else{if(a===0){e.insertAdjacentElement("afterbegin",this._layerControlHTML)}else if(a>0){Array.from(this.parentLayer.src?this.parentLayer.shadowRoot.querySelectorAll(":host > map-extent:not([hidden])"):this.parentLayer.querySelectorAll(":scope > map-extent:not([hidden])"))[a-1]._layerControlHTML.insertAdjacentElement("afterend",this._layerControlHTML)}}this._validateLayerControlContainerHidden()})).catch((()=>{console.log("Error while waiting on parentLayer for map-extent hidden callback")}))}get extent(){const t=t=>Object.assign(s._convertAndFormatPCRS(t._extentLayer.bounds,M[t.units],t.units),{zoom:t._extentLayer.zoomBounds});const e=e=>{e._calculateBounds();return t(e)};return this._extentLayer.bounds?t(this):e(this)}get position(){return n(this.el)}getOuterHTML(){let t=this.el.cloneNode(true);if(this.el.querySelector("map-link")){let e=t.querySelectorAll("map-link");e.forEach((t=>{if(t.hasAttribute("href")){t.setAttribute("href",decodeURI(new URL(t.getAttribute("href"),this.el.baseURI?this.el.baseURI:document.baseURI).href))}else if(t.hasAttribute("tref")){t.setAttribute("tref",decodeURI(new URL(t.getAttribute("tref"),this.el.baseURI?this.el.baseURI:document.baseURI).href))}}))}let e=t.outerHTML;t.remove();return e}zoomTo(){let e=this.extent;let i=this.getMapEl()._map,a=e.topLeft.pcrs.horizontal,n=e.bottomRight.pcrs.horizontal,h=e.bottomRight.pcrs.vertical,r=e.topLeft.pcrs.vertical,l=t.bounds(t.point(a,h),t.point(n,r)),o=i.options.crs.unproject(l.getCenter(true)),m=e.zoom.maxZoom,c=e.zoom.minZoom;i.setView(o,s.getMaxZoom(l,i,c,m),{animate:false})}getMapEl(){return s.getClosest(this.el,"gcds-map")}getLayerEl(){return s.getClosest(this.el,"map-layer,layer-")}async connectedCallback(){this._opacity=this.opacityValue;this._changeHandler=this._handleChange.bind(this);this.parentLayer=this.el.parentLayer=this.getLayerEl();if(this.el.hasAttribute("data-moving")||this.parentLayer?.hasAttribute("data-moving"))return;this.mapEl=this.getMapEl();this.el.getMapEl=this.getMapEl.bind(this);this.el.getLayerEl=this.getLayerEl.bind(this);this.el.getLayerControlHTML=this.getLayerControlHTML.bind(this);this.el.zoomTo=this.zoomTo.bind(this);this.el._validateDisabled=this._validateDisabled.bind(this);this.el.getMeta=this.getMeta.bind(this);this.el.getOuterHTML=this.getOuterHTML.bind(this);Object.defineProperty(this.el,"_boundsCalculated",{get:()=>this._boundsCalculated,configurable:true,enumerable:true});Object.defineProperty(this.el,"extent",{get:()=>this.extent,configurable:true});Object.defineProperty(this.el,"label",{get:()=>this.el.hasAttribute("label")?this.el.getAttribute("label"):this.mapEl?.locale?.dfExtent||"Sub-layer",set:t=>{if(t){this.el.setAttribute("label",t);this._label=t}},configurable:true});if(this.el.hasAttribute("label")){this._label=this.el.getAttribute("label")}if(!this.mapEl)return;await this.mapEl.whenProjectionDefined(this.units).catch((()=>{throw new Error("Undefined projection:"+this.units)}));if(!this.el.isConnected)return;await this.mapEl.whenReady();this._map=this.mapEl._map;this.parentLayer?.addEventListener("map-change",this._changeHandler);this.mapEl.addEventListener("map-projectionchange",this._changeHandler);this._extentLayer=r({opacity:this.opacityValue,crs:M[this.units],zIndex:this.position,extentEl:this.el});this.el._extentLayer=this._extentLayer;const t=l.call(this);this._layerControlHTML=t;this.el._layerControlHTML=t;this.el._layerControlLabel=this._layerControlLabel;this.el._layerControlCheckbox=this._layerControlCheckbox;this.el._opacityControl=this._opacityControl;this.el._opacitySlider=this._opacitySlider;this.el._selectdetails=this._selectdetails;await this._waitForTrefLinks();this._calculateBounds();this._handleChange();this._runMutationObserver(this.el.children);this._bindMutationObserver()}_bindMutationObserver(){this._observer=new MutationObserver((t=>{for(let e of t){if(e.type==="attributes"&&e.attributeName==="label"){if(!this.el.hasAttribute("label")){this._label=this.mapEl?.locale?.dfExtent||"Sub-layer"}}if(e.type==="childList"){this._runMutationObserver(e.addedNodes)}}}));this._observer.observe(this.el,{childList:true,attributes:true,attributeFilter:["label"]})}_runMutationObserver(t){const e=t=>{this.whenReady().then((()=>{this._calculateBounds();this._validateDisabled()}))};const i=t=>{this.whenReady().then((()=>{this._extentLayer.renderStyles(t)}))};const s=t=>{this.whenReady().then((()=>{this._extentLayer.renderStyles(t)}))};for(let a=0;a<t.length;++a){let n=t[a];switch(n.nodeName){case"MAP-META":const t=n.hasAttribute("name")&&(n.getAttribute("name").toLowerCase()==="zoom"||n.getAttribute("name").toLowerCase()==="extent");if(t&&n.hasAttribute("content")){e()}break;case"MAP-LINK":if(n.link&&!n.link.isConnected)i(n);break;case"MAP-STYLE":if(n.styleElement&&!n.styleElement.isConnected){s(n)}break}}}getLayerControlHTML(){return this._layerControlHTML}_projectionMatch(){return this.units.toUpperCase()===this._map.options.projection.toUpperCase()}_validateDisabled(){if(!this._extentLayer)return;let t=this.el.querySelectorAll("map-link[rel=image],map-link[rel=tile],map-link[rel=features],map-link[rel=query]");const e=()=>{let e=t.length,i=0;for(let e=0;e<t.length;e++){if(!t[e].isVisible()){i++}}return i===e};if(!this._projectionMatch()||e()){this.el.setAttribute("disabled","");this.disabled=true}else{this.el.removeAttribute("disabled");this.disabled=false}this.toggleLayerControlDisabled();this._handleChange();return this.disabled}getMeta(t){let e=t.toLowerCase();if(e!=="extent"&&e!=="zoom"&&e!=="cs")return;return this.parentLayer.src?this.el.querySelector(`:scope > map-meta[name=${e}]`)||this.parentLayer.shadowRoot.querySelector(`:host > map-meta[name=${e}]`):this.el.querySelector(`:scope > map-meta[name=${e}]`)||this.parentLayer.querySelector(`:scope > map-meta[name=${e}]`)}toggleLayerControlDisabled(){let t=this._layerControlCheckbox,e=this._layerControlLabel,i=this._opacityControl,s=this._opacitySlider,a=this._selectdetails;if(this.disabled){t.disabled=true;s.disabled=true;e.style.fontStyle="italic";i.style.fontStyle="italic";if(a){a.forEach((t=>{t.querySelectorAll("select").forEach((t=>{t.disabled=true;t.style.fontStyle="italic"}));t.style.fontStyle="italic"}))}}else{t.disabled=false;s.disabled=false;e.style.fontStyle="normal";i.style.fontStyle="normal";if(a){a.forEach((t=>{t.querySelectorAll("select").forEach((t=>{t.disabled=false;t.style.fontStyle="normal"}));t.style.fontStyle="normal"}))}}}_handleChange(){if(this.checked&&!this.disabled&&this.parentLayer._layer){this._extentLayer.addTo(this.parentLayer._layer);this._extentLayer.setZIndex(this.position)}else{this.parentLayer._layer?.removeLayer(this._extentLayer)}}_validateLayerControlContainerHidden(){let t=this.parentLayer._propertiesGroupAnatomy;if(!t)return;const e=this.parentLayer.src?Array.from(this.parentLayer.shadowRoot.querySelectorAll(":host > map-extent")):Array.from(this.parentLayer.querySelectorAll(":scope > map-extent"));const i=e.filter((t=>!t.hidden)).length;if(i===0){t.setAttribute("hidden","")}else{t.removeAttribute("hidden")}}disconnectedCallback(){if(this.el.hasAttribute("data-moving")||this.parentLayer?.hasAttribute("data-moving")||!this._extentLayer)return;this._validateLayerControlContainerHidden();if(this._layerControlHTML){this._layerControlHTML.remove()}if(this.parentLayer?._layer){this.parentLayer._layer.removeLayer(this._extentLayer)}if(this.parentLayer){this.parentLayer.removeEventListener("map-change",this._changeHandler)}if(this.mapEl){this.mapEl.removeEventListener("map-projectionchange",this._changeHandler)}this._boundsCalculated=false;delete this._extentLayer;if(this.parentLayer?._layer)delete this.parentLayer._layer.bounds}async _waitForTrefLinks(){const t=this.el.querySelectorAll("map-link[rel=image][tref],map-link[rel=tile][tref],map-link[rel=features][tref],map-link[rel=query][tref]");const e=[];for(let i of Array.from(t)){e.push(new Promise((t=>{if(i._templateVars){t()}else{const e=setInterval((()=>{if(i._templateVars){clearInterval(e);t()}}),10);setTimeout((()=>{clearInterval(e);t()}),1e3)}})))}return Promise.all(e)}_calculateBounds(){delete this._extentLayer.bounds;delete this._extentLayer.zoomBounds;if(this.parentLayer._layer)delete this.parentLayer._layer.bounds;let e=this.el.querySelectorAll("map-link[rel=image]:not([disabled]),map-link[rel=tile]:not([disabled]),map-link[rel=features]:not([disabled]),map-link[rel=query]:not([disabled])");let i=this.el.querySelector(":scope > map-meta[name=extent][content]")?s.getBoundsFromMeta(this.el):undefined;let a=this.el.querySelector(":scope > map-meta[name=zoom][content]")?s.getZoomBoundsFromMeta(this.el):undefined;for(let s=0;s<e.length;s++){const n=e[s].getZoomBounds(),h=e[s].getBounds();let r=a&&a.hasOwnProperty("maxZoom")?a.maxZoom:-Infinity,l=a&&a.hasOwnProperty("minZoom")?a.minZoom:Infinity,o=a&&a.hasOwnProperty("minNativeZoom")?a.minNativeZoom:Infinity,m=a&&a.hasOwnProperty("maxNativeZoom")?a.maxNativeZoom:-Infinity;if(!a){a=Object.assign({},n)}else{r=Math.max(r,n.maxZoom);l=Math.min(l,n.minZoom);m=Math.max(m,n.maxNativeZoom);o=Math.min(o,n.minNativeZoom);a.minZoom=l;a.maxZoom=r;a.minNativeZoom=o;a.maxNativeZoom=m}if(!i){i=t.bounds(h.min,h.max)}else{i.extend(h)}}if(i){this._extentLayer.bounds=i}else{this._extentLayer.bounds=t.bounds(M[this.units].options.bounds.min,M[this.units].options.bounds.max)}if(!a)a={};if(!a.hasOwnProperty("minZoom")){a.minZoom=0}if(!a.hasOwnProperty("maxZoom")){a.maxZoom=M[this.units].options.resolutions.length-1}if(!a.hasOwnProperty("minNativeZoom")||a.minNativeZoom===Infinity){a.minNativeZoom=a.minZoom}if(!a.hasOwnProperty("maxNativeZoom")||a.maxNativeZoom===-Infinity){a.maxNativeZoom=a.maxZoom}this._extentLayer.zoomBounds=a;this._boundsCalculated=true}async whenReady(){return new Promise(((t,e)=>{let i,s;if(this._extentLayer&&this._boundsCalculated){t()}else{let t=this.el;i=setInterval(a,300,t);s=setTimeout(n,1e4)}function a(a){if(a._extentLayer&&a._boundsCalculated){clearInterval(i);clearTimeout(s);t()}else if(!a.isConnected){clearInterval(i);clearTimeout(s);e("map-extent was disconnected while waiting to be ready")}}function n(){clearInterval(i);clearTimeout(s);e("Timeout reached waiting for extent to be ready")}}))}render(){return null}async whenLinksReady(){let t=this.el.querySelectorAll("map-link[rel=image],map-link[rel=tile],map-link[rel=features],map-link[rel=query]");let e=[];for(let i of Array.from(t)){e.push(i.whenReady())}return Promise.allSettled(e)}static get watchers(){return{units:["unitsChanged"],_label:["labelChanged"],checked:["checkedChanged"],_opacity:["opacityChanged"],hidden:["hiddenChanged"]}}};export{o as map_extent};
//# sourceMappingURL=p-857e339a.entry.js.map