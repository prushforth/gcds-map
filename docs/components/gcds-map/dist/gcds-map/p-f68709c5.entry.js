import{r as t,a as e,U as i,M as s,f as h,l as r,p as n}from"./p-PZrWUcjo.js";import{c as a}from"./p-B4YLD_Og.js";const o=class{constructor(e){t(this,e)}get el(){return e(this)}zoom;min;max;_featureLayer;_geometry;_groupEl;_observer;_parentEl;_initialZoom;_getFeatureExtent;zoomChanged(t,e){if(e!==t&&this._featureLayer){this.reRender(this._featureLayer)}}minChanged(t,e){if(e!==t&&this._featureLayer){this.reRender(this._featureLayer)}}maxChanged(t,e){if(e!==t&&this._featureLayer){this.reRender(this._featureLayer)}}get zoomValue(){let t={},e=this.getMeta("zoom");if(e)t=i._metaContentToObject(e.getAttribute("content"));if(this._parentEl?.nodeName==="MAP-LINK"){return+(this.el.hasAttribute("zoom")?this.el.getAttribute("zoom"):t["value"]?t["value"]:t["max"]?t["max"]:this._initialZoom??this.getMapEl()?.zoom??0)}else{return+(this.el.hasAttribute("zoom")?this.el.getAttribute("zoom"):this._initialZoom??this.getMapEl()?.zoom??0)}}get minValue(){let t={},e=this.getMeta("zoom");if(e)t=i._metaContentToObject(e.getAttribute("content"));let s=0;if(this._parentEl?.nodeName==="MAP-LINK"){return+(this.el.hasAttribute("min")?this.el.getAttribute("min"):t["min"]?t["min"]:this._parentEl.getZoomBounds().minZoom)}else{return+(this.el.hasAttribute("min")?this.el.getAttribute("min"):t["min"]?t["min"]:s)}}get maxValue(){let t={},e=this.getMeta("zoom");if(e)t=i._metaContentToObject(e.getAttribute("content"));let s=this.getMapEl()?._map?.options.crs.options.resolutions.length-1;if(this._parentEl?.nodeName==="MAP-LINK"){return+(this.el.hasAttribute("max")?this.el.getAttribute("max"):t["max"]?t["max"]:this._parentEl.getZoomBounds().maxZoom)}else{return+(this.el.hasAttribute("max")?this.el.getAttribute("max"):t["max"]?t["max"]:s)}}get extent(){if(this.el.isConnected){if(!this._getFeatureExtent){this._getFeatureExtent=this._memoizeExtent()}return this._getFeatureExtent()}}get position(){return a(this.el)}getMapEl(){return i.getClosest(this.el,"gcds-map")}getLayerEl(){return i.getClosest(this.el,"map-layer,layer-")}async connectedCallback(){this._initialZoom=this.getMapEl()?.zoom;this._parentEl=this.el.parentNode?.nodeName==="MAP-LAYER"||this.el.parentNode?.nodeName==="LAYER-"||this.el.parentNode?.nodeName==="MAP-LINK"?this.el.parentNode:this.el.parentNode?.host;if(this.getLayerEl()?.hasAttribute("data-moving")||this._parentEl?.parentElement?.hasAttribute("data-moving"))return;this.el.getMapEl=this.getMapEl.bind(this);this.el.getLayerEl=this.getLayerEl.bind(this);this.el.zoomTo=this.zoomTo.bind(this);this.el.getZoomToZoom=this.getZoomToZoom.bind(this);this.el.click=this.click.bind(this);this.el.focus=this.focus.bind(this);this.el.blur=this.blur.bind(this);this.el.mapml2geojson=this.mapml2geojson.bind(this);this.el.addFeature=this.addFeature.bind(this);this.el.removeFeature=this.removeFeature.bind(this);this.el.reRender=this.reRender.bind(this);Object.defineProperty(this.el,"zoom",{get:()=>this.zoomValue,configurable:true,enumerable:true});Object.defineProperty(this.el,"extent",{get:()=>this.extent,configurable:true,enumerable:true});Object.defineProperty(this.el,"position",{get:()=>this.position,configurable:true,enumerable:true});if(this._parentEl?.nodeName==="MAP-LAYER"||this._parentEl?.nodeName==="LAYER-"||this._parentEl?.nodeName==="MAP-LINK"){this._createOrGetFeatureLayer()}Object.defineProperty(this.el,"_featureLayer",{get:()=>this._featureLayer,configurable:true,enumerable:true});Object.defineProperty(this.el,"_geometry",{get:()=>this._geometry,configurable:true,enumerable:true});this._observer=new MutationObserver((t=>{for(let e of t){if(e.type==="attributes"&&e.target===this.el){return}this.reRender(this._featureLayer)}}));this._observer.observe(this.el,{childList:true,subtree:true,attributes:true,attributeOldValue:true,characterData:true})}disconnectedCallback(){if(this.getLayerEl()?.hasAttribute("data-moving")||this._parentEl?.parentElement?.hasAttribute("data-moving"))return;this._observer?.disconnect();if(this._featureLayer){this.removeFeature(this._featureLayer);if(this._featureLayer.getLayers().length===0){if(this._featureLayer.options.renderer){this._featureLayer.options.renderer.remove()}this._featureLayer.remove();this._featureLayer=null;delete this._featureLayer}}const t=this?._parentEl?._layerRegistry?.get(this.position);if(t){t.count--;if(t.count===0){this._parentEl._layerRegistry.delete(this.position)}}}reRender(t){if(this._groupEl?.isConnected){let e=this._getFallbackCS();let i=document.createElement("span");this._groupEl.insertAdjacentElement("beforebegin",i);if(t._staticFeature){t._removeFromFeaturesList(this._geometry)}t.removeLayer(this._geometry);this._geometry=t.createGeometry(this.el,e).addTo(t);this._groupEl=this.el._groupEl;i.replaceWith(this._geometry.options.group);t._validateRendering();delete this._getFeatureExtent;this._setUpEvents()}}removeFeature(t){t.removeLayer(this._geometry);if(t._staticFeature){t._removeFromFeaturesList(this._geometry)}t.options.properties=null;delete this._geometry;if(this._getFeatureExtent)delete this._getFeatureExtent}addFeature(t){this._featureLayer=t;if(!this.el.querySelector("map-geometry"))return;let e=this._getFallbackCS();this._geometry=t.createGeometry(this.el,e);if(!this._geometry)return;this._groupEl=this.el._groupEl;this._geometry._layerEl=this.getLayerEl();t.addLayer(this._geometry);this._setUpEvents()}getPrevious(){if(this.isFirst()){return null}return this.el.previousElementSibling}isFirst(){return!this._parentEl._layerRegistry.has(this.position)}_createOrGetFeatureLayer(){this._parentEl.whenReady().then((()=>{const t=this._parentEl.nodeName==="MAP-LINK";const e=t?this._parentEl._templatedLayer:this._parentEl._layer;const i=this._parentEl;if(this.isFirst()&&e){let n=i.getMapEl()._map;this._featureLayer=new s(null,{renderer:h(),pane:e.getContainer(),...t&&i.getBounds()?{layerBounds:i.getBounds()}:{},...t?{zoomBounds:this._getZoomBounds()}:{},...t?{}:{_leafletLayer:i._layer},zIndex:this.position,projection:n.options.projection,mapEl:i.getMapEl(),onEachFeature:function(t,e){if(t){const s={autoClose:false,autoPan:true,maxHeight:n.getSize().y*.5-50,maxWidth:n.getSize().x*.7,minWidth:165};var i=document.createElement("div");i.classList.add("mapml-popup-content");i.insertAdjacentHTML("afterbegin",t.innerHTML);e.bindPopup(i,s)}}});r.extend(this._featureLayer.options,{_leafletLayer:Object.assign(this._featureLayer,{_layerEl:this.getLayerEl()})});i._layerRegistry.set(this.position,{layer:this._featureLayer,count:1});this.addFeature(this._featureLayer);e.addLayer(this._featureLayer)}else{const t=i._layerRegistry.get(this.position);this._featureLayer=t?.layer;if(t){t.count++}if(this._featureLayer){this.addFeature(this._featureLayer)}}})).catch((t=>{console.log("Error waiting for parent layer to be ready:",t)}))}_setUpEvents(){["click","focus","blur","keyup","keydown"].forEach((t=>{this._groupEl.addEventListener(t,(e=>{if(t==="click"){let i=new PointerEvent(t,{cancelable:true});i.originalEvent=e;this.el.dispatchEvent(i)}else if(t==="keyup"||t==="keydown"){let i=new KeyboardEvent(t,{cancelable:true});i.originalEvent=e;this.el.dispatchEvent(i)}else{let i=new FocusEvent(t,{cancelable:true});i.originalEvent=e;this.el.dispatchEvent(i)}}))}))}_getFallbackCS(){let t;if(this._parentEl?.nodeName==="MAP-LINK"){t=this._parentEl.shadowRoot?.querySelector("map-meta[name=cs][content]")||this._parentEl.parentElement?.getMeta?.("cs")}else{let e=this.getLayerEl();t=e?.src?e.shadowRoot?.querySelector("map-meta[name=cs][content]"):e?.querySelector("map-meta[name=cs][content]")}return t?i._metaContentToObject(t.getAttribute("content")).content:"gcrs"}_memoizeExtent(){let t;return()=>{if(t&&this._getFeatureExtent){return t}else{let e=this.getMapEl()._map,s=this.el.querySelector("map-geometry"),h=s?.getAttribute("cs")||this._getFallbackCS(),n=this.zoomValue,a=s?.querySelectorAll("map-point, map-linestring, map-polygon, map-multipoint, map-multilinestring"),o=[Infinity,Infinity,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];if(a){for(let t of Array.from(a)){let e=t.querySelectorAll("map-coordinates");for(let i=0;i<e.length;++i){o=this._updateExtent(t,e[i],o)}}}let l=r.point(o[0],o[1]);let m=r.point(o[2],o[3]);let u=i.boundsToPCRSBounds(r.bounds(l,m),n,e.options.projection,h);if(a?.length===1&&a[0].tagName.toUpperCase()==="MAP-POINT"){let t=e.options.projection,s=this.el.hasAttribute("max")?+this.el.getAttribute("max"):M[t].options.resolutions.length-1,h=M[t].options.crs.tile.bounds.getCenter(),n=M[t].transformation.transform(u.min,M[t].scale(+this.zoomValue||s));u=i.pixelToPCRSBounds(r.bounds(n.subtract(h),n.add(h)),this.zoomValue||s,t)}let c=Object.assign(i._convertAndFormatPCRS(u,e.options.crs,e.options.projection),{zoom:this._getZoomBounds()});t=c;return c}}}_updateExtent(t,e,s){let h=e.innerHTML.trim().replace(/<[^>]+>/g,"").replace(/\s+/g," ").split(/[<>\ ]/g);switch(t.tagName.toUpperCase()){case"MAP-POINT":s=i._updateExtent(s,+h[0],+h[1]);break;case"MAP-LINESTRING":case"MAP-POLYGON":case"MAP-MULTIPOINT":case"MAP-MULTILINESTRING":for(let t=0;t<h.length;t+=2){s=i._updateExtent(s,+h[t],+h[t+1])}break}return s}_getZoomBounds(){return{minZoom:this.minValue,maxZoom:this.maxValue,minNativeZoom:this.zoomValue,maxNativeZoom:this.zoomValue}}getZoomToZoom(){let t=this.extent.topLeft.pcrs,e=this.extent.bottomRight.pcrs,s=r.bounds(r.point(t.horizontal,t.vertical),r.point(e.horizontal,e.vertical));let h=this.getMapEl()._map.options.projection,n=this.getLayerEl().extent.zoom,a=n.minZoom?n.minZoom:0,o=n.maxZoom?n.maxZoom:M[h].options.resolutions.length-1;let l;if(this.el.hasAttribute("zoom")){l=this.zoomValue}else{l=i.getMaxZoom(s,this.getMapEl()._map,a,o);if(this.maxValue<l){l=this.maxValue}else if(this.minValue>l){l=this.minValue}}if(l<a){l=a}else if(l>o){l=o}return l}getMeta(t){let e=t.toLowerCase();if(e!=="cs"&&e!=="zoom"&&e!=="projection")return null;let i=this._parentEl?.shadowRoot?.querySelector(`map-meta[name=${e}][content]`);if(this._parentEl?.nodeName==="MAP-LINK"){return i||this._parentEl.parentElement?.getMeta?.(t)}else{return this._parentEl?.src?this._parentEl.shadowRoot?.querySelector(`map-meta[name=${e}][content]`):this._parentEl?.querySelector(`map-meta[name=${e}][content]`)}}mapml2geojson(t){let e={propertyFunction:null,transform:true};t=Object.assign({},e,t);let s={type:"Feature",properties:{},geometry:{}};let h=this.el.querySelector("map-properties");if(!h){s.properties=null}else if(typeof t.propertyFunction==="function"){s.properties=t.propertyFunction(h)}else if(h.querySelector("table")){let t=h.querySelector("table").cloneNode(true);s.properties=i._table2properties(t)}else{s.properties={prop0:h.innerHTML.replace(/(<([^>]+)>)/gi,"").replace(/\s/g,"")}}let r=null,a=null,o=this.getMapEl()._map;if(t.transform){r=new n.Proj(o.options.crs.code);a=new n.Proj("EPSG:4326");if(o.options.crs.code==="EPSG:3857"||o.options.crs.code==="EPSG:4326"){t.transform=false}}let l=this.el.querySelector("map-geometry")?.querySelector("map-geometrycollection"),m=this.el.querySelector("map-geometry")?.querySelectorAll("map-point, map-polygon, map-linestring, map-multipoint, map-multipolygon, map-multilinestring");if(l){s.geometry.type="GeometryCollection";s.geometry.geometries=[];if(m){for(let e of Array.from(m)){s.geometry.geometries.push(i._geometry2geojson(e,r,a,t.transform))}}}else if(m&&m.length>0){s.geometry=i._geometry2geojson(m[0],r,a,t.transform)}return s}click(){let t=this._groupEl,e=t.getBoundingClientRect();let i=new MouseEvent("click",{clientX:e.x+e.width/2,clientY:e.y+e.height/2,button:0});let s=this.el.querySelector("map-properties");if(t.getAttribute("role")==="link"){for(let e of t.children){e.mousedown?.call(this._geometry,i);e.mouseup?.call(this._geometry,i)}}let h=new PointerEvent("click",{cancelable:true});h.originalEvent=i;this.el.dispatchEvent(h);if(s&&this.el.isConnected){let t=this._geometry,e=t._layers;for(let t in e){if(e[t].isPopupOpen()){e[t].closePopup()}}if(t.isPopupOpen()){t.closePopup()}else if(!h.originalEvent.cancelBubble){t.openPopup()}}}focus(t){this._groupEl?.focus(t)}blur(){if(document.activeElement?.shadowRoot?.activeElement===this._groupEl||document.activeElement?.shadowRoot?.activeElement?.parentNode===this._groupEl){this._groupEl.blur();this.getMapEl()?._map?.getContainer().focus()}}zoomTo(){let t=this.extent,e=this.getMapEl()._map;let i=t.topLeft.pcrs,s=t.bottomRight.pcrs,h=r.bounds(r.point(i.horizontal,i.vertical),r.point(s.horizontal,s.vertical)),n=e.options.crs.unproject(h.getCenter(true));e.setView(n,this.getZoomToZoom(),{animate:false})}async whenReady(){return new Promise(((t,e)=>{let i,s;if(this.el.addFeature){t()}else{let t=this.el;i=setInterval(h,200,t);s=setTimeout(r,5e3)}function h(e){if(e.addFeature){clearInterval(i);clearTimeout(s);t()}}function r(){clearInterval(i);clearTimeout(s);e("Timeout reached waiting for feature to be ready")}}))}render(){return null}static get watchers(){return{zoom:["zoomChanged"],min:["minChanged"],max:["maxChanged"]}}};export{o as map_feature};
//# sourceMappingURL=p-f68709c5.entry.js.map