import{r as t,a as i,U as s}from"./p-PZrWUcjo.js";import{m as e}from"./p-C8xJJwPc.js";import{c as h}from"./p-B4YLD_Og.js";const n=class{constructor(i){t(this,i)}get el(){return i(this)}row;col;zoom;src;_parentEl;_tileLayer;_extent;_initialRow;_initialCol;_initialZoom;_hasConnected=false;srcChanged(t,i){if(i!==t){if(this._extent)this._calculateExtent();if(this._tileLayer){this._tileLayer.removeMapTile(this.el);this._tileLayer.addMapTile(this.el)}}}connectedCallback(){this._initialRow=this.el.hasAttribute("row")?+this.el.getAttribute("row"):this.row??0;this._initialCol=this.el.hasAttribute("col")?+this.el.getAttribute("col"):this.col??0;let t=0;if(this.el.hasAttribute("zoom")){t=+this.el.getAttribute("zoom")}else if(this.zoom!==undefined){t=this.zoom}else{const i=this._getMetaZoomValue();if(i!==null){t=i}else{t=this.getMapEl()?.zoom||0}}this._initialZoom=t;this._hasConnected=true;const i=this.el.getAttribute.bind(this.el);const s=this.el.setAttribute.bind(this.el);this.el.getAttribute=t=>{if(this._hasConnected){switch(t){case"row":return String(this._initialRow);case"col":return String(this._initialCol);case"zoom":return String(this._initialZoom)}}return i(t)};this.el.setAttribute=(t,i)=>{if(this._hasConnected){switch(t){case"row":case"col":case"zoom":return}}s(t,i)};Object.defineProperties(this.el,{row:{get:()=>this._initialRow,configurable:true},col:{get:()=>this._initialCol,configurable:true},zoom:{get:()=>this._initialZoom,configurable:true}});const e=this.el.parentNode;this._parentEl=e.nodeName==="MAP-LAYER"||e.nodeName==="LAYER-"||e.nodeName==="MAP-LINK"?e:e.host;const h=new Image;h.src=this.src||"";this._createOrGetTileLayer()}disconnectedCallback(){if(this._tileLayer){this._tileLayer.removeMapTile(this.el);if(this._tileLayer._mapTiles&&this._tileLayer._mapTiles.length===0){this._tileLayer.remove();this._tileLayer=null;delete this._tileLayer;const t=this?._parentEl?._layerRegistry?.get(this.position);if(t){t.count--;if(t.count===0){this._parentEl._layerRegistry.delete(this.position)}}}}}get rowValue(){return this._hasConnected?this._initialRow:+this.row}get colValue(){return this._hasConnected?this._initialCol:+this.col}get zoomValue(){return this._hasConnected?this._initialZoom:+this.zoom}get extent(){if(!this._extent)this._calculateExtent();return this._extent}get position(){return h(this.el)}isFirst(){return!this._parentEl._layerRegistry.has(this.position)}getPrevious(){if(this.isFirst())return null;return this.el.previousElementSibling}async zoomTo(){const t=this.extent;const i=this.getMapEl()?._map;if(!t||!i)return;const e=t.topLeft.pcrs.horizontal,h=t.bottomRight.pcrs.horizontal,n=t.bottomRight.pcrs.vertical,o=t.topLeft.pcrs.vertical,r=window.L.bounds(window.L.point(e,n),window.L.point(h,o)),c=i.options.crs.unproject(r.getCenter(true)),a=t.zoom.maxZoom,l=t.zoom.minZoom;i.setView(c,s.getMaxZoom(r,i,l,a),{animate:false})}getMapEl(){return s.getClosest(this.el,"gcds-map")}getLayerEl(){return s.getClosest(this.el,"map-layer,layer-")}_getMetaZoomValue(){const t=this.getLayerEl();if(!t)return null;const i=t.querySelector('map-meta[name="zoom"][content]');if(!i)return null;const s=i.getAttribute("content");if(!s)return null;const e=s.match(/value=(\d+)/);if(e&&e[1]){return parseInt(e[1],10)}return null}getMeta(t){const i=t.toLowerCase();if(i!=="cs"&&i!=="zoom"&&i!=="projection")return;const s=this._parentEl?.shadowRoot?.querySelector(`map-meta[name=${i}][content]`);if(this._parentEl?.nodeName==="MAP-LINK"){return s||this._parentEl.parentElement?.getMeta(t)}else{return this._parentEl?.src?this._parentEl.shadowRoot?.querySelector(`map-meta[name=${i}][content]`):this._parentEl.querySelector(`map-meta[name=${i}][content]`)}}async _createOrGetTileLayer(){if(!this._parentEl?.whenReady)return;await this._parentEl.whenReady();const t=this._parentEl;if(this.isFirst()){this._tileLayer=e({projection:this.getMapEl()?.projection,opacity:1,pane:t._templatedLayer?.getContainer?.()||t._layer?.getContainer?.(),zIndex:this.position});this._tileLayer.addMapTile(this.el);if(t._templatedLayer?.addLayer){t._templatedLayer.addLayer(this._tileLayer)}else{t._layer?.addLayer?.(this._tileLayer)}this.el._tileLayer=this._tileLayer;t._layerRegistry.set(this.position,{layer:this._tileLayer,count:1})}else{const i=t._layerRegistry.get(this.position);this._tileLayer=i?.layer;if(i){i.count++}if(this._tileLayer){this._tileLayer.addMapTile(this.el);this.el._tileLayer=this._tileLayer}}}_calculateExtent(){const t=this.getMapEl();if(!t||!t._map)return;const i=t._map;const e=i.options.projection;const h=window.M[e].options.crs.tile.bounds.max.x;const n=this.colValue*h;const o=this.rowValue*h;const r=window.L.bounds(window.L.point(n,o),window.L.point(n+h,o+h));const c=s.pixelToPCRSBounds(r,this.zoomValue,e);this._extent=s._convertAndFormatPCRS(c,i.options.crs,e);this._extent.zoom={minZoom:this.zoomValue,maxZoom:this.zoomValue,minNativeZoom:this.zoomValue,maxNativeZoom:this.zoomValue}}render(){return null}static get watchers(){return{src:["srcChanged"]}}};export{n as map_tile};
//# sourceMappingURL=p-d7822cc6.entry.js.map