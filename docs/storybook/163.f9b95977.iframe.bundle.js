"use strict";(self.webpackChunkgcds_map=self.webpackChunkgcds_map||[]).push([[163],{"./dist/esm/calculatePosition-B4YLD_Og.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function calculatePosition(element){const tagName=element.tagName.toLowerCase(),validTags=["map-tile","map-extent","map-feature"];if(!validTags.includes(tagName))return console.warn(`calculatePosition: Invalid element type ${tagName}`),0;const parent=element.parentNode;if(!parent)return 1;const children=parent.children||Array.from(parent.childNodes).filter(node=>node.nodeType===Node.ELEMENT_NODE);if(!children||0===children.length)return 1;let position=0,lastTag=null,foundTarget=!1;for(const child of children){if(child.nodeType!==Node.ELEMENT_NODE)continue;const childTag=child.tagName.toLowerCase();if(validTags.includes(childTag)){if(child===element)return foundTarget=!0,"map-extent"===childTag?(position++,position):(lastTag===childTag||position++,position);foundTarget||("map-extent"===childTag||null!==lastTag&&lastTag!==childTag?position++:null===lastTag&&(position=1),lastTag=childTag)}}return 0}__webpack_require__.d(__webpack_exports__,{c:()=>calculatePosition})},"./dist/esm/map-feature.entry.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{map_feature:()=>MapFeature});var _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./dist/esm/index-PZrWUcjo.js"),_calculatePosition_B4YLD_Og_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./dist/esm/calculatePosition-B4YLD_Og.js");const MapFeature=class{constructor(hostRef){(0,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.r)(this,hostRef)}get el(){return(0,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.a)(this)}zoom;min;max;_featureLayer;_geometry;_groupEl;_observer;_parentEl;_initialZoom;_getFeatureExtent;zoomChanged(newValue,oldValue){oldValue!==newValue&&this._featureLayer&&this.reRender(this._featureLayer)}minChanged(newValue,oldValue){oldValue!==newValue&&this._featureLayer&&this.reRender(this._featureLayer)}maxChanged(newValue,oldValue){oldValue!==newValue&&this._featureLayer&&this.reRender(this._featureLayer)}get zoomValue(){let meta={},metaEl=this.getMeta("zoom");return metaEl&&(meta=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._metaContentToObject(metaEl.getAttribute("content"))),"MAP-LINK"===this._parentEl?.nodeName?+(this.el.hasAttribute("zoom")?this.el.getAttribute("zoom"):meta.value?meta.value:meta.max?meta.max:this._initialZoom??this.getMapEl()?.zoom??0):+(this.el.hasAttribute("zoom")?this.el.getAttribute("zoom"):this._initialZoom??this.getMapEl()?.zoom??0)}get minValue(){let meta={},metaEl=this.getMeta("zoom");metaEl&&(meta=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._metaContentToObject(metaEl.getAttribute("content")));return"MAP-LINK"===this._parentEl?.nodeName?+(this.el.hasAttribute("min")?this.el.getAttribute("min"):meta.min?meta.min:this._parentEl.getZoomBounds().minZoom):+(this.el.hasAttribute("min")?this.el.getAttribute("min"):meta.min?meta.min:0)}get maxValue(){let meta={},metaEl=this.getMeta("zoom");metaEl&&(meta=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._metaContentToObject(metaEl.getAttribute("content")));let projectionMaxZoom=this.getMapEl()?._map?.options.crs.options.resolutions.length-1;return"MAP-LINK"===this._parentEl?.nodeName?+(this.el.hasAttribute("max")?this.el.getAttribute("max"):meta.max?meta.max:this._parentEl.getZoomBounds().maxZoom):+(this.el.hasAttribute("max")?this.el.getAttribute("max"):meta.max?meta.max:projectionMaxZoom)}get extent(){if(this.el.isConnected)return this._getFeatureExtent||(this._getFeatureExtent=this._memoizeExtent()),this._getFeatureExtent()}get position(){return(0,_calculatePosition_B4YLD_Og_js__WEBPACK_IMPORTED_MODULE_1__.c)(this.el)}getMapEl(){return _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getClosest(this.el,"gcds-map")}getLayerEl(){return _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getClosest(this.el,"map-layer,layer-")}async connectedCallback(){this._initialZoom=this.getMapEl()?.zoom,this._parentEl="MAP-LAYER"===this.el.parentNode?.nodeName||"LAYER-"===this.el.parentNode?.nodeName||"MAP-LINK"===this.el.parentNode?.nodeName?this.el.parentNode:this.el.parentNode?.host,this.getLayerEl()?.hasAttribute("data-moving")||this._parentEl?.parentElement?.hasAttribute("data-moving")||(this.el.getMapEl=this.getMapEl.bind(this),this.el.getLayerEl=this.getLayerEl.bind(this),this.el.zoomTo=this.zoomTo.bind(this),this.el.getZoomToZoom=this.getZoomToZoom.bind(this),this.el.click=this.click.bind(this),this.el.focus=this.focus.bind(this),this.el.blur=this.blur.bind(this),this.el.mapml2geojson=this.mapml2geojson.bind(this),this.el.addFeature=this.addFeature.bind(this),this.el.removeFeature=this.removeFeature.bind(this),this.el.reRender=this.reRender.bind(this),Object.defineProperty(this.el,"zoom",{get:()=>this.zoomValue,configurable:!0,enumerable:!0}),Object.defineProperty(this.el,"extent",{get:()=>this.extent,configurable:!0,enumerable:!0}),Object.defineProperty(this.el,"position",{get:()=>this.position,configurable:!0,enumerable:!0}),"MAP-LAYER"!==this._parentEl?.nodeName&&"LAYER-"!==this._parentEl?.nodeName&&"MAP-LINK"!==this._parentEl?.nodeName||this._createOrGetFeatureLayer(),Object.defineProperty(this.el,"_featureLayer",{get:()=>this._featureLayer,configurable:!0,enumerable:!0}),Object.defineProperty(this.el,"_geometry",{get:()=>this._geometry,configurable:!0,enumerable:!0}),this._observer=new MutationObserver(mutationList=>{for(let mutation of mutationList){if("attributes"===mutation.type&&mutation.target===this.el)return;this.reRender(this._featureLayer)}}),this._observer.observe(this.el,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0}))}disconnectedCallback(){if(this.getLayerEl()?.hasAttribute("data-moving")||this._parentEl?.parentElement?.hasAttribute("data-moving"))return;this._observer?.disconnect(),this._featureLayer&&(this.removeFeature(this._featureLayer),0===this._featureLayer.getLayers().length&&(this._featureLayer.options.renderer&&this._featureLayer.options.renderer.remove(),this._featureLayer.remove(),this._featureLayer=null,delete this._featureLayer));const entry=this?._parentEl?._layerRegistry?.get(this.position);entry&&(entry.count--,0===entry.count&&this._parentEl._layerRegistry.delete(this.position))}reRender(layerToRenderOn){if(this._groupEl?.isConnected){let fallbackCS=this._getFallbackCS(),placeholder=document.createElement("span");this._groupEl.insertAdjacentElement("beforebegin",placeholder),layerToRenderOn._staticFeature&&layerToRenderOn._removeFromFeaturesList(this._geometry),layerToRenderOn.removeLayer(this._geometry),this._geometry=layerToRenderOn.createGeometry(this.el,fallbackCS).addTo(layerToRenderOn),this._groupEl=this.el._groupEl,placeholder.replaceWith(this._geometry.options.group),layerToRenderOn._validateRendering(),delete this._getFeatureExtent,this._setUpEvents()}}removeFeature(layerToRemoveFrom){layerToRemoveFrom.removeLayer(this._geometry),layerToRemoveFrom._staticFeature&&layerToRemoveFrom._removeFromFeaturesList(this._geometry),layerToRemoveFrom.options.properties=null,delete this._geometry,this._getFeatureExtent&&delete this._getFeatureExtent}addFeature(layerToAddTo){if(this._featureLayer=layerToAddTo,!this.el.querySelector("map-geometry"))return;let fallbackCS=this._getFallbackCS();this._geometry=layerToAddTo.createGeometry(this.el,fallbackCS),this._geometry&&(this._groupEl=this.el._groupEl,this._geometry._layerEl=this.getLayerEl(),layerToAddTo.addLayer(this._geometry),this._setUpEvents())}getPrevious(){return this.isFirst()?null:this.el.previousElementSibling}isFirst(){return!this._parentEl._layerRegistry.has(this.position)}_createOrGetFeatureLayer(){this._parentEl.whenReady().then(()=>{const isMapLink="MAP-LINK"===this._parentEl.nodeName,parentLayer=isMapLink?this._parentEl._templatedLayer:this._parentEl._layer,parentElement=this._parentEl;if(this.isFirst()&&parentLayer){let map=parentElement.getMapEl()._map;this._featureLayer=new _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.M(null,{renderer:(0,_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.f)(),pane:parentLayer.getContainer(),...isMapLink&&parentElement.getBounds()?{layerBounds:parentElement.getBounds()}:{},...isMapLink?{zoomBounds:this._getZoomBounds()}:{},...isMapLink?{}:{_leafletLayer:parentElement._layer},zIndex:this.position,projection:map.options.projection,mapEl:parentElement.getMapEl(),onEachFeature:function(properties,geometry){if(properties){const popupOptions={autoClose:!1,autoPan:!0,maxHeight:.5*map.getSize().y-50,maxWidth:.7*map.getSize().x,minWidth:165};var c=document.createElement("div");c.classList.add("mapml-popup-content"),c.insertAdjacentHTML("afterbegin",properties.innerHTML),geometry.bindPopup(c,popupOptions)}}}),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.extend(this._featureLayer.options,{_leafletLayer:Object.assign(this._featureLayer,{_layerEl:this.getLayerEl()})}),parentElement._layerRegistry.set(this.position,{layer:this._featureLayer,count:1}),this.addFeature(this._featureLayer),parentLayer.addLayer(this._featureLayer)}else{const entry=parentElement._layerRegistry.get(this.position);this._featureLayer=entry?.layer,entry&&entry.count++,this._featureLayer&&this.addFeature(this._featureLayer)}}).catch(error=>{console.log("Error waiting for parent layer to be ready:",error)})}_setUpEvents(){["click","focus","blur","keyup","keydown"].forEach(name=>{this._groupEl.addEventListener(name,e=>{if("click"===name){let clickEv=new PointerEvent(name,{cancelable:!0});clickEv.originalEvent=e,this.el.dispatchEvent(clickEv)}else if("keyup"===name||"keydown"===name){let keyEv=new KeyboardEvent(name,{cancelable:!0});keyEv.originalEvent=e,this.el.dispatchEvent(keyEv)}else{let focusEv=new FocusEvent(name,{cancelable:!0});focusEv.originalEvent=e,this.el.dispatchEvent(focusEv)}})})}_getFallbackCS(){let csMeta;if("MAP-LINK"===this._parentEl?.nodeName)csMeta=this._parentEl.shadowRoot?.querySelector("map-meta[name=cs][content]")||this._parentEl.parentElement?.getMeta?.("cs");else{let layerEl=this.getLayerEl();csMeta=layerEl?.src?layerEl.shadowRoot?.querySelector("map-meta[name=cs][content]"):layerEl?.querySelector("map-meta[name=cs][content]")}return csMeta?_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._metaContentToObject(csMeta.getAttribute("content")).content:"gcrs"}_memoizeExtent(){let extentCache;return()=>{if(extentCache&&this._getFeatureExtent)return extentCache;{let map=this.getMapEl()._map,geometry=this.el.querySelector("map-geometry"),cs=geometry?.getAttribute("cs")||this._getFallbackCS(),zoom=this.zoomValue,shapes=geometry?.querySelectorAll("map-point, map-linestring, map-polygon, map-multipoint, map-multilinestring"),bboxExtent=[1/0,1/0,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];if(shapes)for(let shape of Array.from(shapes)){let coord=shape.querySelectorAll("map-coordinates");for(let i=0;i<coord.length;++i)bboxExtent=this._updateExtent(shape,coord[i],bboxExtent)}let topLeft=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(bboxExtent[0],bboxExtent[1]),bottomRight=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(bboxExtent[2],bboxExtent[3]),pcrsBound=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.boundsToPCRSBounds(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds(topLeft,bottomRight),zoom,map.options.projection,cs);if(1===shapes?.length&&"MAP-POINT"===shapes[0].tagName.toUpperCase()){let projection=map.options.projection,maxZoom=this.el.hasAttribute("max")?+this.el.getAttribute("max"):M[projection].options.resolutions.length-1,tileCenter=M[projection].options.crs.tile.bounds.getCenter(),pixel=M[projection].transformation.transform(pcrsBound.min,M[projection].scale(+this.zoomValue||maxZoom));pcrsBound=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.pixelToPCRSBounds(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds(pixel.subtract(tileCenter),pixel.add(tileCenter)),this.zoomValue||maxZoom,projection)}let result=Object.assign(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._convertAndFormatPCRS(pcrsBound,map.options.crs,map.options.projection),{zoom:this._getZoomBounds()});return extentCache=result,result}}}_updateExtent(shape,coord,bboxExtent){let data=coord.innerHTML.trim().replace(/<[^>]+>/g,"").replace(/\s+/g," ").split(/[<>\ ]/g);switch(shape.tagName.toUpperCase()){case"MAP-POINT":bboxExtent=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._updateExtent(bboxExtent,+data[0],+data[1]);break;case"MAP-LINESTRING":case"MAP-POLYGON":case"MAP-MULTIPOINT":case"MAP-MULTILINESTRING":for(let i=0;i<data.length;i+=2)bboxExtent=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._updateExtent(bboxExtent,+data[i],+data[i+1])}return bboxExtent}_getZoomBounds(){return{minZoom:this.minValue,maxZoom:this.maxValue,minNativeZoom:this.zoomValue,maxNativeZoom:this.zoomValue}}getZoomToZoom(){let newZoom,tL=this.extent.topLeft.pcrs,bR=this.extent.bottomRight.pcrs,bound=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(tL.horizontal,tL.vertical),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(bR.horizontal,bR.vertical)),projection=this.getMapEl()._map.options.projection,layerZoomBounds=this.getLayerEl().extent.zoom,minZoom=layerZoomBounds.minZoom?layerZoomBounds.minZoom:0,maxZoom=layerZoomBounds.maxZoom?layerZoomBounds.maxZoom:M[projection].options.resolutions.length-1;return this.el.hasAttribute("zoom")?newZoom=this.zoomValue:(newZoom=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U.getMaxZoom(bound,this.getMapEl()._map,minZoom,maxZoom),this.maxValue<newZoom?newZoom=this.maxValue:this.minValue>newZoom&&(newZoom=this.minValue)),newZoom<minZoom?newZoom=minZoom:newZoom>maxZoom&&(newZoom=maxZoom),newZoom}getMeta(metaName){let name=metaName.toLowerCase();if("cs"!==name&&"zoom"!==name&&"projection"!==name)return null;let sdMeta=this._parentEl?.shadowRoot?.querySelector(`map-meta[name=${name}][content]`);return"MAP-LINK"===this._parentEl?.nodeName?sdMeta||this._parentEl.parentElement?.getMeta?.(metaName):this._parentEl?.src?this._parentEl.shadowRoot?.querySelector(`map-meta[name=${name}][content]`):this._parentEl?.querySelector(`map-meta[name=${name}][content]`)}mapml2geojson(options){options=Object.assign({},{propertyFunction:null,transform:!0},options);let json={type:"Feature",properties:{},geometry:{}},el=this.el.querySelector("map-properties");if(el)if("function"==typeof options.propertyFunction)json.properties=options.propertyFunction(el);else if(el.querySelector("table")){let table=el.querySelector("table").cloneNode(!0);json.properties=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._table2properties(table)}else json.properties={prop0:el.innerHTML.replace(/(<([^>]+)>)/gi,"").replace(/\s/g,"")};else json.properties=null;let source=null,dest=null,map=this.getMapEl()._map;options.transform&&(source=new _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.p.Proj(map.options.crs.code),dest=new _index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.p.Proj("EPSG:4326"),"EPSG:3857"!==map.options.crs.code&&"EPSG:4326"!==map.options.crs.code||(options.transform=!1));let collection=this.el.querySelector("map-geometry")?.querySelector("map-geometrycollection"),shapes=this.el.querySelector("map-geometry")?.querySelectorAll("map-point, map-polygon, map-linestring, map-multipoint, map-multipolygon, map-multilinestring");if(collection){if(json.geometry.type="GeometryCollection",json.geometry.geometries=[],shapes)for(let shape of Array.from(shapes))json.geometry.geometries.push(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._geometry2geojson(shape,source,dest,options.transform))}else shapes&&shapes.length>0&&(json.geometry=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.U._geometry2geojson(shapes[0],source,dest,options.transform));return json}click(){let g=this._groupEl,rect=g.getBoundingClientRect(),event=new MouseEvent("click",{clientX:rect.x+rect.width/2,clientY:rect.y+rect.height/2,button:0}),properties=this.el.querySelector("map-properties");if("link"===g.getAttribute("role"))for(let path of g.children)path.mousedown?.call(this._geometry,event),path.mouseup?.call(this._geometry,event);let clickEv=new PointerEvent("click",{cancelable:!0});if(clickEv.originalEvent=event,this.el.dispatchEvent(clickEv),properties&&this.el.isConnected){let geometry=this._geometry,shapes=geometry._layers;for(let id in shapes)shapes[id].isPopupOpen()&&shapes[id].closePopup();geometry.isPopupOpen()?geometry.closePopup():clickEv.originalEvent.cancelBubble||geometry.openPopup()}}focus(options){this._groupEl?.focus(options)}blur(){document.activeElement?.shadowRoot?.activeElement!==this._groupEl&&document.activeElement?.shadowRoot?.activeElement?.parentNode!==this._groupEl||(this._groupEl.blur(),this.getMapEl()?._map?.getContainer().focus())}zoomTo(){let extent=this.extent,map=this.getMapEl()._map,tL=extent.topLeft.pcrs,bR=extent.bottomRight.pcrs,bound=_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.bounds(_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(tL.horizontal,tL.vertical),_index_PZrWUcjo_js__WEBPACK_IMPORTED_MODULE_0__.l.point(bR.horizontal,bR.vertical)),center=map.options.crs.unproject(bound.getCenter(!0));map.setView(center,this.getZoomToZoom(),{animate:!1})}async whenReady(){return new Promise((resolve,reject)=>{let interval,failureTimer;if(this.el.addFeature)resolve();else{let featureElement=this.el;interval=setInterval(function testForFeature(featureElement){featureElement.addFeature&&(clearInterval(interval),clearTimeout(failureTimer),resolve())},200,featureElement),failureTimer=setTimeout(function featureNotDefined(){clearInterval(interval),clearTimeout(failureTimer),reject("Timeout reached waiting for feature to be ready")},5e3)}})}render(){return null}static get watchers(){return{zoom:["zoomChanged"],min:["minChanged"],max:["maxChanged"]}}}}}]);